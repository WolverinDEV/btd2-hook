# Ninja Kiwi API
This documentation tries to cover the HTTP API for `api.ninjakiwi.com`.  
Please note that there is no official documentation. Everything contained within this
documentation has been observed by analyzing requests made by the game `Ballons Towser Defense 2` (BTD2).


## Request format
Every request unless specified otherwise is JSON encoded.
The root object must contain the following fields:
- `nonce` A random generated text for each request.
- `sig` The signature generated for verifying the session.
- `data` The actual request data as string (might be a JSON encoded object).
- `auth` Auth information about the user which itself is a JSON object containing the following fields:
  - `session` The users session token
  - `device` A string uniquely? identifying the users device
  - `skuID` This is for BTD2 `1704`. I'm not sure where this number comes from
  - `appID` This is for BTD2 `17`.

### Generating a nonce
As nonce any string seems to be allowed (This hasn't been tested).  
  
An example nonce generated by BTD2 would be `20:1662219209:1662135256823:`.  
The first number is the running request number.  
The second two numbers seem to be timestamps.  
The last part is unknown.

### Generating a signature
A request signature is an MH5 hash of the following elements:
1. The users' session token
2. Static (might be specific to BTD2) token `B42D1230A78185FF`
3. The payload string
4. The nonce
These elements are concatenated in the order given above and then the md5 digest is taken.

### Getting the auth information
I'm currently not sure, where the game stores the auth information.  
The easiest way, to retrieve the auth information by using the injector.

### Example
An example request would look like this:
```json
{
    "nonce": "20:1662219209:1662135256823:",
    "sig": "8273e82dfe7fdef692b1a5771898f4bb",
    "data": "some data...",
    "auth": {
      "session": "e64e5c9ab27337be4f5e7e85b627404c",
      "device": "NO_LINK{6e8e68db35f017b979b5579a665057e3}",
      "skuID": 1704,
      "appID": 17
    }
}
```
Note: `sig` has been calculated as following:
```
MD5("e64e5c9ab27337be4f5e7e85b627404c" + "B42D1230A78185FF" + "some data..." + "20:1662219209:1662135256823:")
```

## Response format
Similar to the request format, the response is a JSON encoded object containing the following fields:
- `error` Unknown
- `data` Response data as string. Usually a JSON encoded object
- `sig` The signature generated for verifying the response.
- 
### Verifying the signature
I'm not bothered verifying the response since I just assume it's valid.  
I don't know how the `sig` is generated but assume it's similar to the request.  
While investigating the request `sig` I noticed a similar constant token `A2DC98AEBFF138BC`.


## Undocumented URLs
URLs which have not yet been documented:
- https://static-api.nkstatic.com/appdocs/17/appdocs/skuBranch?v=10601
- https://static-api.nkstatic.com/nkapi/skusettings/[Profile XXX].json  
This might be downloading the users profile in NK GNDATA format.
- https://bundles.nkstatic.com/battles2/production/dlc_manifest_18991_windows.txt?v=10601